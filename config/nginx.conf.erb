worker_processes 1;

# ← Required for a valid Nginx configuration
events {
  worker_connections 1024;
}

http {
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
  access_log  /dev/stdout  main;
  error_log   /dev/stderr  warn;

  client_max_body_size 10M;
  add_header X-Frame-Options        "SAMEORIGIN";
  add_header X-Content-Type-Options "nosniff";
  add_header X-XSS-Protection       "1; mode=block";
  add_header Referrer-Policy        "strict-origin-when-cross-origin";
  # add_header Content-Security-Policy "<your CSP here>";

  # Define the FastAPI backend
  upstream uvicorn {
    server 127.0.0.1:<%= ENV['PORT'] %>;
  }

  server {
    listen      <%= ENV['PORT'] %>;
    server_name _;

    # ← Use HOME to locate your built React files
    root  <%= ENV['HOME'] %>/frontend/dist;

    # 1) Proxy API calls
    location /api/v1/ {
      proxy_pass         http://uvicorn;
      proxy_http_version 1.1;
      proxy_set_header   Upgrade $http_upgrade;
      proxy_set_header   Connection "upgrade";
      proxy_set_header   Host $host;
      proxy_set_header   X-Real-IP           $remote_addr;
      proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto   $scheme;
      proxy_connect_timeout 60s;
      proxy_send_timeout    60s;
      proxy_read_timeout    60s;
    }

    # 2) Cache static assets (including your favicon)
    location ~* \.(?:ico|css|js|gif|jpe?g|png|svg|woff2?|ttf|eot)$ {
      expires    1y;
      add_header Cache-Control "public";
      access_log off;
      try_files  $uri =404;
    }

    # 3) SPA fallback for React Router
    location / {
      try_files $uri $uri/ /index.html;
    }

    # 4) Block hidden files
    location ~ /\. {
      deny all;
    }
  }
}