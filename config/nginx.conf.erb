worker_processes 1;

events {
  worker_connections 1024;
}

http {
  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                  '$status $body_bytes_sent "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';
  access_log  /dev/stdout  main;
  error_log   /dev/stderr  warn;

  client_max_body_size 10M;
  add_header X-Frame-Options        "SAMEORIGIN";
  add_header X-Content-Type-Options "nosniff";
  add_header X-XSS-Protection       "1; mode=block";
  add_header Referrer-Policy        "strict-origin-when-cross-origin";

  # 1) Uvicorn now listens on port 8000 internally
  upstream uvicorn {
    server 127.0.0.1:8000;
  }

  server {
    # 2) Nginx binds to Heroku's assigned port only
    listen      <%= ENV['PORT'] %>;
    server_name _;

    root  <%= ENV['HOME'] %>/frontend/dist;

    # 3) Proxy /api/v1/* to Uvicorn at 127.0.0.1:8000
    location /api/v1/ {
      proxy_pass         http://uvicorn;
      proxy_http_version 1.1;
      proxy_set_header   Upgrade $http_upgrade;
      proxy_set_header   Connection "upgrade";
      proxy_set_header   Host $host;
      proxy_set_header   X-Real-IP           $remote_addr;
      proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Proto   $scheme;
      proxy_connect_timeout 60s;
      proxy_send_timeout    60s;
      proxy_read_timeout    60s;
    }

    # 4) Cache static assets (JS/CSS/Images/Favicon)
    location ~* \.(?:ico|css|js|gif|jpe?g|png|svg|woff2?|ttf|eot)$ {
      expires    1y;
      add_header Cache-Control "public";
      access_log off;
      try_files  $uri =404;
    }

    # 5) SPA fallback (React Router)
    location / {
      try_files $uri $uri/ /index.html;
    }

    # 6) Block hidden files
    location ~ /\. {
      deny all;
    }
  }
}